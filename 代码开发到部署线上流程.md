# 代码开发到部署线上流程

## 一、创建代码仓库

### 第1步：选择代码托管平台
可以选择这些平台之一：
- GitHub（国外最流行）
- GitLab（功能强大）
- Gitee（国内访问快）
- 公司自建的Git服务器

### 第2步：新建项目仓库
1. 登录你选择的平台（比如GitHub）
2. 点击"新建仓库"按钮
3. 填写以下信息：
   - **仓库名称**：比如 `my-project`（建议用英文小写，用-连接）
   - **仓库描述**：简单说明这个项目是做什么的
   - **公开还是私有**：公司项目一般选私有
   - **初始化README**：可以勾选，会自动创建一个说明文件
   - **添加.gitignore**：选择对应的语言模板（比如Node）

### 第3步：添加团队成员
1. 进入仓库设置
2. 找到"成员管理"或"Collaborators"
3. 添加你的同事，设置他们的权限
   - **管理员**：可以做任何操作
   - **开发者**：可以提交代码
   - **访客**：只能查看

---

## 二、把代码下载到本地电脑

### 第1步：复制仓库地址
在仓库页面找到"克隆"或"Clone"按钮，复制地址，有两种格式：
- **HTTPS格式**：`https://github.com/用户名/项目名.git`
- **SSH格式**：`git@github.com:用户名/项目名.git`（推荐，不用每次输密码）

### 第2步：在电脑上下载代码
打开终端（命令行），输入：
```bash
# 下载代码到本地
git clone git@github.com:用户名/项目名.git

# 进入项目文件夹
cd 项目名
```

### 第3步：配置你的Git身份信息
告诉Git你是谁，这样提交记录会显示你的名字：
```bash
# 设置你的名字
git config user.name "张三"

# 设置你的邮箱
git config user.email "zhangsan@company.com"

# 查看配置是否成功
git config --list
```

---

## 三、在本地开发代码

### 第1步：创建自己的开发分支
不要直接在主分支上改代码！要创建一个新分支：
```bash
# 创建一个新分支并切换过去
git checkout -b feature/登录功能

# 分支命名建议：
# feature/功能名    - 开发新功能时用
# bugfix/bug描述    - 修复bug时用
# hotfix/紧急修复   - 线上出问题紧急修时用
```

### 第2步：安装项目依赖
第一次运行项目需要安装依赖包：
```bash
# 如果是npm项目
npm install

# 如果是yarn项目
yarn install

# 如果是pnpm项目
pnpm install
```

### 第3步：开始写代码
1. 用编辑器（VS Code等）打开项目
2. 开始写你的功能代码
3. 本地运行看效果：
```bash
# 启动开发服务器（具体命令看项目的package.json）
npm run dev
# 或者
npm start
```

### 第4步：本地测试
写完代码要测试一下：
```bash
# 运行测试用例
npm run test

# 检查代码规范（有没有语法错误、格式问题）
npm run lint

# 尝试打包构建（确保能正常打包）
npm run build
```

---

## 四、提交代码到仓库

### 第1步：查看你改了哪些文件
```bash
# 看看哪些文件被修改了
git status

# 查看具体改了什么内容
git diff
```

### 第2步：把修改的文件加入暂存区
```bash
# 把所有修改的文件都加进去
git add .

# 或者只加某个文件
git add src/login.js
```

### 第3步：提交代码
```bash
# 提交并写上说明（说明你做了什么）
git commit -m "feat: 完成用户登录功能"

# 提交说明的规范：
# feat: 新增功能
# fix: 修复bug
# docs: 修改文档
# style: 调整代码格式（不影响功能）
# refactor: 重构代码
# test: 添加测试
```

### 第4步：推送到远程仓库
```bash
# 第一次推送这个分支，需要这样写
git push -u origin feature/登录功能

# 以后再推送就简单了
git push
```

### 第5步：发起合并请求（Pull Request）
1. 打开GitHub/GitLab网页
2. 会看到提示创建"Pull Request"或"Merge Request"
3. 点击创建，填写说明
4. 指定同事来审查你的代码
5. 等待审查通过后合并

---

## 五、代码仓库分支管理（重点）

### 理解两个主要分支

#### 1. master分支（正式环境）
- 这是**线上生产环境**的代码
- **永远是稳定可用的**
- 这个分支的代码就是用户正在使用的版本
- **不能直接在这个分支上改代码**
- 只有测试通过的代码才能合并进来

#### 2. develop分支（测试环境）
- 这是**测试环境**的代码
- 所有开发人员的代码都先合并到这里
- 在这个分支上进行联调测试
- 测试没问题后，才会合并到master

### 分支使用流程图

```
master分支（线上正式）
   ↑
   │ 测试通过后才合并
   │
develop分支（测试环境）
   ↑
   │ 功能开发完成后合并
   │
feature分支（个人开发）
```

### 实际工作中怎么用

**场景1：开发新功能**
```bash
# 从develop分支创建功能分支
git checkout develop
git pull                          # 先拉取最新代码
git checkout -b feature/购物车    # 创建功能分支

# ... 开发代码 ...
# ... 本地测试 ...

# 提交代码
git add .
git commit -m "feat: 添加购物车功能"
git push -u origin feature/购物车

# 然后在网页上创建Pull Request，合并到develop分支
```

**场景2：测试通过，上线**
```bash
# develop测试通过后，合并到master上线
git checkout master
git pull
git merge develop
git push

# 打一个版本标签
git tag -a v1.0.0 -m "发布1.0.0版本"
git push origin v1.0.0
```

**场景3：线上出bug，紧急修复**
```bash
# 从master创建紧急修复分支
git checkout master
git pull
git checkout -b hotfix/修复支付bug

# ... 修复bug ...

# 提交修复
git add .
git commit -m "fix: 修复支付金额计算错误"
git push -u origin hotfix/修复支付bug

# 合并到master（上线）
git checkout master
git merge hotfix/修复支付bug
git push

# 也要合并回develop（保持代码同步）
git checkout develop
git merge hotfix/修复支付bug
git push
```

---

## 六、使用Jenkins自动部署

### 什么是Jenkins？
Jenkins是一个自动化工具，可以帮你自动完成：
1. 拉取最新代码
2. 安装依赖
3. 运行测试
4. 打包构建
5. 部署到服务器

不用每次手动操作，省时省力！

### 部署到测试环境（develop分支）

**触发方式：** 当代码合并到develop分支时，Jenkins自动执行

**Jenkins会做这些事：**
1. 从Git拉取develop分支最新代码
2. 运行 `npm install` 安装依赖
3. 运行 `npm run lint` 检查代码规范
4. 运行 `npm run test` 跑测试用例
5. 运行 `npm run build:test` 打包代码
6. 把打包好的文件上传到测试服务器
7. 重启测试服务器上的应用

**访问地址：** `http://test.公司域名.com`

### 部署到正式环境（master分支）

**触发方式：** 需要**手动点击**确认部署（防止误操作）

**Jenkins会做这些事：**
1. 从Git拉取master分支代码
2. 安装依赖、检查代码、运行测试
3. 打包生产环境代码
4. **备份当前线上版本**（方便回滚）
5. 弹出确认窗口，问你"确定要部署吗？"
6. 点确定后，上传到生产服务器
7. 重启线上服务
8. 检查服务是否正常启动

**访问地址：** `http://www.公司域名.com`

### Jenkins部署配置说明

#### 测试环境配置（develop分支→测试服务器）
```
任务名称：deploy-test
触发条件：develop分支有新代码推送时自动执行

执行步骤：
1. 拉取develop分支代码
2. npm install（安装依赖）
3. npm run lint（代码检查）
4. npm run test（运行测试）
5. npm run build:test（打包）
6. 上传到测试服务器的 /var/www/test 目录
7. 执行 pm2 restart app-test（重启应用）
```

#### 生产环境配置（master分支→正式服务器）
```
任务名称：deploy-production
触发条件：手动点击"立即构建"

执行步骤：
1. 拉取master分支代码
2. npm ci（安装依赖，确保版本一致）
3. npm run lint（代码检查）
4. npm run test（运行测试）
5. npm run build:prod（打包生产代码）
6. 备份当前线上版本到 /var/backups/
7. 弹窗确认"确定要部署到生产环境吗？"
8. 上传到生产服务器的 /var/www/production 目录
9. 执行 pm2 reload app-prod（平滑重启）
10. 等待10秒，检查服务健康状态
11. 如果失败，自动回滚到备份版本
```

---

## 七、完整开发流程示例

### 日常开发一个新功能（从头到尾）

```bash
# ========== 第1步：准备开发 ==========
# 切到develop分支，拉取最新代码
git checkout develop
git pull origin develop

# 创建自己的功能分支
git checkout -b feature/用户注册


# ========== 第2步：开发代码 ==========
# 打开编辑器写代码...
# 启动本地服务测试
npm run dev


# ========== 第3步：提交代码 ==========
# 查看改了哪些文件
git status

# 添加到暂存区
git add .

# 提交
git commit -m "feat: 完成用户注册功能，包括手机号验证"

# 推送到远程
git push -u origin feature/用户注册


# ========== 第4步：发起代码审查 ==========
# 1. 打开GitHub/GitLab网页
# 2. 点击"Create Pull Request"
# 3. 选择：feature/用户注册 → develop
# 4. 填写说明，指定审查人（比如你的leader）
# 5. 等待审查通过


# ========== 第5步：合并到develop ==========
# 审查通过后，在网页上点击"Merge"按钮
# Jenkins自动部署到测试环境


# ========== 第6步：测试环境验证 ==========
# 测试人员在 http://test.公司域名.com 测试你的功能
# 如果有bug，继续在feature分支修改，重复第3-6步


# ========== 第7步：准备上线 ==========
# 测试全部通过后，将develop合并到master
git checkout master
git pull origin master
git merge develop

# 打一个版本标签
git tag -a v1.2.0 -m "发布1.2.0版本：新增用户注册功能"
git push origin master --tags


# ========== 第8步：部署到线上 ==========
# 1. 登录Jenkins
# 2. 找到"deploy-production"任务
# 3. 点击"立即构建"
# 4. 弹窗确认后，等待部署完成
# 5. 访问 http://www.公司域名.com 验证功能


# ========== 第9步：清理分支 ==========
# 功能上线后，删除功能分支
git branch -d feature/用户注册
git push origin --delete feature/用户注册
```

---

## 八、四个环境对比

| 环境名称 | 对应分支 | 用途 | 访问地址 | 谁使用 |
|---------|---------|------|---------|--------|
| 本地环境 | feature/xxx | 开发调试 | localhost:3000 | 开发人员自己 |
| 测试环境 | develop | 功能测试、联调 | test.xxx.com | 测试人员、开发人员 |
| 预发布环境 | release/xxx | 上线前最后验证 | pre.xxx.com | 测试人员、产品经理 |
| 生产环境 | master | 真实用户使用 | www.xxx.com | 所有用户 |

### 环境配置文件
项目里通常有这些配置文件：
```
.env.development   → 本地开发环境配置
.env.test          → 测试环境配置
.env.pre           → 预发布环境配置
.env.production    → 生产环境配置
```

---

## 九、上线后出问题怎么办？（回滚）

### 什么是回滚？
就是把代码恢复到上一个正常的版本。

### 如何回滚？

**方法1：使用备份文件回滚（推荐）**
```bash
# Jenkins部署时会自动备份，直接恢复备份即可
# 在Jenkins找到"回滚"任务，选择要恢复的版本，点击执行
```

**方法2：手动Git回滚**
```bash
# 回退到指定版本
git checkout master
git reset --hard v1.1.0     # 回退到1.1.0版本
git push -f origin master   # 强制推送

# 然后在Jenkins重新部署
```

### 回滚后要做什么？
1. 检查网站能否正常访问
2. 测试核心功能（登录、下单等）
3. 查看错误日志，确保没有报错
4. 通知团队：已回滚到哪个版本

---

## 十、注意事项（避坑指南）

### 1. 代码规范
- ✅ 提交前运行 `npm run lint` 检查代码
- ✅ 写清楚commit信息，让别人知道你改了什么
- ✅ 及时更新文档（README.md）
- ❌ 不要提交console.log调试代码

### 2. 安全注意
- ✅ 配置文件用.env，不要写死密码
- ❌ 不要把密码、密钥提交到Git
- ✅ 定期更新依赖包（npm update）
- ✅ 敏感配置放在服务器环境变量

### 3. 部署注意
- ✅ 测试环境测试通过才能上线
- ✅ 重要更新在非高峰期（晚上或周末）部署
- ✅ 部署后盯着监控，看有无报错
- ✅ 准备好回滚方案
- ❌ 不要直接在master分支改代码
- ❌ 不要在周五下午上线（出问题周末都要加班）

### 4. 团队协作
- ✅ 每天早上拉取最新代码（git pull）
- ✅ 及时删除已合并的分支
- ✅ 代码审查要认真，不要应付
- ✅ 遇到问题及时沟通，不要憋着

---

## 十一、常用Git命令速查表

### 查看相关
```bash
git status              # 查看当前状态（哪些文件改了）
git log                 # 查看提交历史
git log --oneline       # 查看简洁版提交历史
git diff                # 查看改了什么内容
git branch              # 查看本地所有分支
git branch -a           # 查看本地+远程所有分支
```

### 分支操作
```bash
git checkout develop              # 切换到develop分支
git checkout -b feature/新功能    # 创建并切换到新分支
git branch -d feature/旧功能      # 删除本地分支
git push origin --delete feature/旧功能  # 删除远程分支
```

### 提交代码
```bash
git add .                          # 添加所有修改
git add src/login.js               # 添加指定文件
git commit -m "feat: 添加登录"     # 提交
git push                           # 推送到远程
git push -u origin feature/分支名  # 第一次推送新分支
```

### 拉取代码
```bash
git pull                    # 拉取当前分支最新代码
git pull origin develop     # 拉取develop分支最新代码
git fetch origin            # 获取远程更新（但不合并）
```

### 撤销操作
```bash
git checkout -- 文件名       # 撤销对某个文件的修改
git reset HEAD 文件名        # 取消add（从暂存区移除）
git reset --hard HEAD~1      # 撤销最后一次提交（危险！）
```

### 暂存工作
```bash
git stash              # 暂时保存当前修改（还没写完，要切分支）
git stash list         # 查看暂存列表
git stash pop          # 恢复暂存的修改
```

---

## 十二、常见问题解答

**Q1：git push被拒绝，提示没有权限？**
```
解决方法：
1. 检查是否配置了SSH密钥
2. 在GitHub/GitLab检查是否有仓库权限
3. 询问管理员给你添加权限
```

**Q2：合并代码时出现冲突怎么办？**
```bash
# 1. 拉取最新代码时提示冲突
git pull origin develop
# 提示：CONFLICT (content): Merge conflict in src/login.js

# 2. 打开冲突文件，会看到这样的标记：
<<<<<<< HEAD
你的代码
=======
别人的代码
>>>>>>> develop

# 3. 手动解决冲突（删除标记，保留正确的代码）

# 4. 解决后提交
git add .
git commit -m "merge: 解决合并冲突"
git push
```

**Q3：不小心在master分支改了代码怎么办？**
```bash
# 1. 暂存当前修改
git stash

# 2. 创建新分支
git checkout -b feature/补救分支

# 3. 恢复修改
git stash pop

# 4. 正常提交
git add .
git commit -m "feat: xxx"
git push -u origin feature/补救分支
```

**Q4：Jenkins部署失败怎么排查？**
```
1. 点击Jenkins任务，查看"控制台输出"
2. 看具体报错信息：
   - npm install失败 → 检查package.json
   - 测试未通过 → 修复测试用例
   - 构建失败 → 检查构建脚本
3. 本地先跑一遍 npm run build，确保能成功
4. 如果看不懂错误，复制错误信息问同事或搜索
```

**Q5：代码推送后，测试环境没更新？**
```
检查清单：
□ 确认代码已经合并到develop分支
□ 检查Jenkins任务是否执行成功
□ 查看Jenkins控制台有无报错
□ 清除浏览器缓存（Ctrl+F5强制刷新）
□ 询问运维检查服务器
```

---

## 十三、流程图总结

### 完整开发上线流程图

```
开发人员
   ↓
① 从develop创建feature分支
   ↓
② 本地开发+测试
   ↓
③ 提交代码，推送到远程
   ↓
④ 创建Pull Request
   ↓
⑤ 代码审查
   ↓
⑥ 合并到develop分支
   ↓
⑦ Jenkins自动部署测试环境
   ↓
⑧ 测试人员测试
   ↓
⑨ 测试通过，合并到master
   ↓
⑩ 手动触发Jenkins部署生产环境
   ↓
⑪ 线上验证功能
   ↓
⑫ 发布成功，打版本标签
```

---

## 总结

这个流程看起来步骤很多，但实际上核心就是：

1. **开发阶段**：feature分支写代码 → 提交 → PR审查 → 合并到develop
2. **测试阶段**：develop自动部署测试环境 → 测试人员验证
3. **上线阶段**：合并到master → Jenkins部署生产 → 线上验证

**记住几个要点：**
- develop分支 = 测试环境
- master分支 = 线上正式环境
- 不要直接在主分支改代码
- 上线前一定要在测试环境测试通过
- 准备好回滚方案

熟练之后，这些操作会变成肌肉记忆，就像吃饭睡觉一样自然！
